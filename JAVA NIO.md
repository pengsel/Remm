# JAVA NIO

### 一些概念

#### 缓冲区

“输入/输出”讲的无非就是把数据移进或移出缓冲区。

磁盘中的数据通过 DMA 操作搬移到内核空间的缓存区，装满之后，内核就把数据从内核空间的临时缓冲区拷贝到进程执行read()调用时指定的缓冲区。

![1565875278282](/home/duanpeng/.config/Typora/typora-user-images/1565875278282.png)

为何先要拷贝到内核空间？

* 硬件通常不能直接访问用户空间
* 磁盘是基于块存储的设备，操作的是固定大小的数据块，而用户进程请求的可能是任意大小的或非对齐的数据块。内核负责数据的分解和组合操作。

#### 内核空间和用户空间

用户空间是常规进程所在区域。用户空间是非特权区域:比如,在该区域执行的代码就不能直接访问硬件设备。JVM就是常规进程。

内核空间是操作系统所在区域。内核代码有特别的权力:它能与设备控制器通讯,控制着用户区域
进程的运行状态,等等。

#### 虚拟内存

使用虚假(或虚拟)地址取代物理(硬件RAM)内存地址。

好处：

* 一个以上的虚拟地址可以指向同一个物理地址；
* 虚拟内存空间可大于实际可用的硬件内存。

把内核空间地址与用户空间的虚拟地址映射到同一个物理地址,这样,DMA 硬件(只能访问物理内存地址)就可以填充对内核与用户空间进程同时可见的缓冲区。

![1565872402241](/home/duanpeng/.config/Typora/typora-user-images/1565872402241.png)

省去了内核空间和用户空间的往来拷贝，但是有前提条件：

* 内核和用户缓冲区使用相同的页对齐；
* 缓冲区的大小必须是磁盘控制器块大小(通常为512字节磁盘扇区)的倍数。

#### 内存页面调度

虚拟内存分页，为了支持虚拟内存的寻址空间大于物理内存的特性。虚拟内存空间的页面可以继续存在于外部磁盘存储，这样为物理内存中的其他虚拟页面腾出了空间。

所有磁盘I/O操作都在页层面完成。

页错误的产生：

* CPU引用某内存地址
* MMU(内存管理单元)确定该地址所在页，转换成物理页号
* 如果当前不存在与虚拟页形成有效映射的物理页，MMU向CPU提交一个页错误
* 页错误产生一个系统调用，控制权交给内核，附带导致错误的虚拟地址信息，内核采取步骤校验页的有效性。
  * 内核安排页面调入操作，把缺失的页内容读回物理内存。
  * 会导致别的页被移出物理内存，给新的页挪地方。此时如果待移出的页已经被碰过了(内容发生过改变)，还必须首先把内容拷贝到磁盘的分页区(页面调出操作)。
  * 如果地址不是有效的虚拟内存地址，那么该页不能通过验证，会产生段错误，此时控制权转交给内核的另一部分，通常的结果是该进程被强令关闭。
* 通过了验证之后，MMU随即刷新，建立该虚拟地址和物理地址的映射(如果有必要的话，中断移出页的映射)，用户进程得以继续进行，用户对此过程不会有任何感知。

#### 文件I/O

文件系统。是安排、解释磁盘数据的一种独特方式，定义了文件名、路径、文件、文件属性等抽象概念。文件系统将一连串大小一致的数据块组织到一起。这些数据块包括，目录、索引、文件数据、单个文件的元信息。

采用分页技术的操作系统执行I/O的全过程：

* 确定请求的数据分布在文件系统的哪些页(磁盘扇区组)。磁盘上的文件内容和元数据可能跨越多个文件系统页,而且这些页可能也不连续。
* 在内核空间分配足够数量的内存页,以容纳得到确定的文件系统页。
* 在内存页与磁盘上的文件系统页之间建立映射。
* 为每一个内存页产生**页错误**。(即将该页内容读入物理内存，并建立虚拟地址和物理地址的映射)
* 虚拟内存系统俘获页错误,安排页面调入,从磁盘上读取页内容,使页有效。
* 一旦页面调入操作完成,文件系统即对原始数据进行解析,取得所需文件内容或属性
  信息。



#### 内存映射文件

内存映射I/O，允许用户进程最大限度的利用面向页的系统I/O特性，并完全摒弃缓冲区拷贝。内存映射I/O使用文件系统建立从用户空间直到可用文件系统页的虚拟内存映射，这样的好处：

* 用户进程把文件数据当作内存,所以无需发布 read( )或 write( )系统调用。
* 当用户进程碰触到映射内存空间,页错误会自动产生,从而将文件数据从磁盘读进内存。如果用户修改了映射内存空间,相关页会自动标记为脏,随后刷新到磁盘,文件得到更新。
* 操作系统的虚拟内存子系统会对页进行智能高速缓存,自动根据系统负载进行内存管理。
* 数据总是按页对齐的,**无需执行缓冲区拷贝**。
* 大型文件使用映射,无需耗费大量内存,即可进行数据拷贝。

![1565875305760](/home/duanpeng/.config/Typora/typora-user-images/1565875305760.png)

**虚拟内存和磁盘I/O紧密相连**，如果数据缓冲区是按页对齐的，且大小是内建页大小的的倍数，那么，对于大圩偶数操作系统而言，处理效率会大幅提升。

#### 文件锁定

文件锁定机制允许一个进程阻止其他进程存取文件，或限制其存取方式。通常的用途是控制共享信息的更新方式或用于事务隔离。数据库就严重依赖于文件锁定。

文件锁定与特定文件相关，开始于文件的某个特定字节地址，包含特定数量的连续字节。这对于协调多个进程互不影响地访问文件不同区域至关重要。

共享锁和独占锁。

文件锁分建议使用和强制使用：

* 建议型文件锁会向提出请求的进程提供当前锁定信息，由相关进程进行协调并关注锁定信息。
* 强制型锁由操作系统或者文件系统强制实施，不管进程对锁的存在知道与否，都会阻止其对文件锁定区域的访问。(Windows使用的强制型锁)

#### 流I/O

上述的I/O是基于块的，也有流I/O，其原理模仿了通道。I/O字节流必须顺序存取，常见的例子是网络连接。

流的传输一般比块设备慢，经常用于间歇性输入。

多数操作系统允许把流置于非块模式，这样，进程可以查看流上是否有输入，及时没有也不影响干别的（这个是否说明，块模式会影响进程干别的）-> 再有输入的时候进行处理，输入流闲置的时候执行其他功能。

非块模式更进一步->就绪性选择，它和非块模式类似，只是把查看流是否就绪的任务交给了操作系统。操作系统受命查看一系列流，并提醒进程哪些流已经就绪。凭借操作系统返回的就绪信息，进程可以使用相同代码和单一线程实现多活动流的多路传输。